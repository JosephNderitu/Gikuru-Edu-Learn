<!-- notes/books/edit_book.html -->
{% extends 'core/base_with_sidebar.html' %}
{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-purple-50 py-8 px-4">
    <div class="max-w-4xl mx-auto">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="w-20 h-20 bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                <i class="fas fa-edit text-white text-2xl"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Edit Book</h1>
            <p class="text-gray-600">Update book information and APA7 citation details</p>
        </div>

        <!-- Book Preview -->
        <div class="mb-6 bg-white rounded-xl shadow-md border border-gray-200 p-4">
            <div class="flex items-center space-x-4">
                {% if book.cover_image %}
                <img src="{{ book.cover_image.url }}" alt="{{ book.title }} cover" 
                     class="w-16 h-20 object-cover rounded-lg shadow-sm">
                {% else %}
                <div class="w-16 h-20 bg-gradient-to-br from-blue-100 to-indigo-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-book text-blue-600"></i>
                </div>
                {% endif %}
                <div>
                    <h3 class="font-semibold text-gray-900">{{ book.title }}</h3>
                    <p class="text-sm text-gray-600">
                        {{ book.author_last_name }}, {{ book.author_first_name.0 }}.
                        {% if book.publication_year %} • {{ book.publication_year }}{% endif %}
                        {% if book.edition > 1 %} • {{ book.edition }}th Ed.{% endif %}
                    </p>
                    <div class="flex items-center mt-1">
                        <span class="text-xs px-2 py-1 rounded-full {% if book.is_required %}bg-amber-100 text-amber-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                            {% if book.is_required %}Required Reading{% else %}Recommended{% endif %}
                        </span>
                        <span class="text-xs text-gray-500 ml-2">{{ book.subject.title }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Card -->
        <div class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <!-- Form Header -->
            <div class="bg-gradient-to-r from-amber-600 to-orange-700 px-6 py-4">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                        <i class="fas fa-edit text-white text-lg"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-white">Update Book Information</h2>
                        <p class="text-amber-100 text-sm">Modify book details as needed</p>
                    </div>
                </div>
            </div>

            <!-- Form Content -->
            <form method="POST" enctype="multipart/form-data" class="p-6 space-y-6">
                {% csrf_token %}
                
                <!-- Basic Information -->
                <div class="space-y-4">
                    <h3 class="text-sm font-semibold text-gray-700 flex items-center space-x-2">
                        <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                        <span>Basic Information</span>
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Title -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">
                                Title <span class="text-red-500">*</span>
                            </label>
                            {{ form.title }}
                            {% if form.title.errors %}
                            <div class="text-red-600 text-xs">{{ form.title.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- Subtitle -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">
                                Subtitle (Optional)
                            </label>
                            {{ form.subtitle }}
                        </div>
                    </div>

                    <!-- Subject -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">
                            Course Subject <span class="text-red-500">*</span>
                        </label>
                        {{ form.subject }}
                        {% if form.subject.errors %}
                        <div class="text-red-600 text-xs">{{ form.subject.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Description -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">
                            Description
                        </label>
                        {{ form.description }}
                    </div>
                </div>

                <!-- Author Information -->
                <div class="space-y-4">
                    <h3 class="text-sm font-semibold text-gray-700 flex items-center space-x-2">
                        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                        <span>Author Information (APA7 Format)</span>
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Author First Name -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">
                                Author First Name <span class="text-red-500">*</span>
                            </label>
                            {{ form.author_first_name }}
                            {% if form.author_first_name.errors %}
                            <div class="text-red-600 text-xs">{{ form.author_first_name.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- Author Last Name -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">
                                Author Last Name <span class="text-red-500">*</span>
                            </label>
                            {{ form.author_last_name }}
                            {% if form.author_last_name.errors %}
                            <div class="text-red-600 text-xs">{{ form.author_last_name.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Additional Authors -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">
                            Additional Authors (Optional)
                        </label>
                        {{ form.additional_authors }}
                        <p class="text-xs text-gray-500">Format: Lastname, F. (e.g., Smith, J. or Doe, J., Johnson, K.)</p>
                    </div>
                </div>

                <!-- Publication Details -->
                <div class="space-y-4">
                    <h3 class="text-sm font-semibold text-gray-700 flex items-center space-x-2">
                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        <span>Publication Details</span>
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Publication Year -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">
                                Publication Year <span class="text-red-500">*</span>
                            </label>
                            {{ form.publication_year }}
                            {% if form.publication_year.errors %}
                            <div class="text-red-600 text-xs">{{ form.publication_year.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- Edition -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">
                                Edition
                            </label>
                            {{ form.edition }}
                        </div>

                        <!-- Publisher -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">
                                Publisher <span class="text-red-500">*</span>
                            </label>
                            {{ form.publisher }}
                            {% if form.publisher.errors %}
                            <div class="text-red-600 text-xs">{{ form.publisher.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Identifiers -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- ISBN -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">
                                ISBN (Optional)
                            </label>
                            {{ form.isbn }}
                            <p class="text-xs text-gray-500">10 or 13 digits</p>
                        </div>

                        <!-- URL -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">
                                URL (Optional)
                            </label>
                            {{ form.url }}
                        </div>
                    </div>
                </div>

                <!-- Files -->
                <div class="space-y-4">
                    <h3 class="text-sm font-semibold text-gray-700 flex items-center space-x-2">
                        <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                        <span>Files</span>
                    </h3>
                    
                    <!-- Current Files -->
                    <div class="mb-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Current Files:</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Cover Image -->
                            <div class="border border-gray-200 rounded-lg p-4">
                                <p class="text-sm font-medium text-gray-700 mb-2">Cover Image</p>
                                {% if book.cover_image %}
                                <div class="flex items-center space-x-3">
                                    <img src="{{ book.cover_image.url }}" alt="Current cover" 
                                         class="w-12 h-16 object-cover rounded">
                                    <div>
                                        <p class="text-xs text-gray-600">Current cover</p>
                                        <label class="text-xs text-blue-600 hover:text-blue-800 cursor-pointer">
                                            {{ form.cover_image }}
                                            Change image
                                        </label>
                                    </div>
                                </div>
                                {% else %}
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 hover:border-purple-400 transition">
                                    {{ form.cover_image }}
                                    <div class="text-center">
                                        <i class="fas fa-image text-gray-400 text-xl mb-2"></i>
                                        <p class="text-sm text-gray-600">No cover image</p>
                                        <p class="text-xs text-gray-500">Click to upload</p>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- PDF File -->
                            <div class="border border-gray-200 rounded-lg p-4">
                                <p class="text-sm font-medium text-gray-700 mb-2">PDF File</p>
                                {% if book.pdf_file %}
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-16 bg-red-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-file-pdf text-red-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-600">{{ book.get_file_size }}</p>
                                        <label class="text-xs text-red-600 hover:text-red-800 cursor-pointer">
                                            {{ form.pdf_file }}
                                            Change PDF
                                        </label>
                                    </div>
                                </div>
                                {% else %}
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 hover:border-red-400 transition">
                                    {{ form.pdf_file }}
                                    <div class="text-center">
                                        <i class="fas fa-file-pdf text-red-400 text-xl mb-2"></i>
                                        <p class="text-sm text-gray-600">No PDF file</p>
                                        <p class="text-xs text-gray-500">Click to upload</p>
                                    </div>
                                </div>
                                {% endif %}
                                {% if form.pdf_file.errors %}
                                <div class="text-red-600 text-xs mt-2">{{ form.pdf_file.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Details -->
                <div class="space-y-4">
                    <h3 class="text-sm font-semibold text-gray-700 flex items-center space-x-2">
                        <div class="w-2 h-2 bg-amber-500 rounded-full"></div>
                        <span>Additional Details</span>
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Pages -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">
                                Number of Pages
                            </label>
                            {{ form.pages }}
                        </div>

                        <!-- Language -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">
                                Language
                            </label>
                            {{ form.language }}
                        </div>

                        <!-- Required -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">
                                Book Status
                            </label>
                            <div class="flex items-center space-x-2 mt-2">
                                {{ form.is_required }}
                                <span class="text-sm text-gray-700">Required Reading</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Current Citation -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
                        <div class="text-sm text-blue-700">
                            <p class="font-medium">Current APA7 Citation:</p>
                            <p id="current-citation" class="italic mt-1">
                                {{ book.get_apa7_citation }}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Preview Citation -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <i class="fas fa-eye text-green-500 mt-0.5"></i>
                        <div class="text-sm text-green-700">
                            <p class="font-medium">Updated APA7 Citation Preview:</p>
                            <p id="citation-preview" class="italic mt-1">
                                {{ book.get_apa7_citation }}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3 pt-6 border-t border-gray-200">
                    <button type="submit" 
                            class="flex-1 bg-gradient-to-r from-amber-600 to-orange-700 hover:from-amber-700 hover:to-orange-800 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 shadow-lg flex items-center justify-center space-x-2">
                        <i class="fas fa-save"></i>
                        <span>Save Changes</span>
                    </button>
                    
                    <a href="{% url 'book_detail' book.id %}" 
                       class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition flex items-center justify-center">
                        <i class="fas fa-times mr-2"></i>
                        Cancel
                    </a>
                    
                    <a href="{% url 'delete_book' book.id %}" 
                       class="flex-1 px-6 py-3 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 transition flex items-center justify-center">
                        <i class="fas fa-trash mr-2"></i>
                        Delete Book
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Citation preview
    function updateCitationPreview() {
        const authorLastName = document.querySelector('[name="author_last_name"]')?.value || '';
        const authorFirstName = document.querySelector('[name="author_first_name"]')?.value || '';
        const publicationYear = document.querySelector('[name="publication_year"]')?.value || '';
        const title = document.querySelector('[name="title"]')?.value || '';
        const subtitle = document.querySelector('[name="subtitle"]')?.value || '';
        const edition = document.querySelector('[name="edition"]')?.value || '1';
        const publisher = document.querySelector('[name="publisher"]')?.value || '';
        
        if (authorLastName && authorFirstName && publicationYear && title && publisher) {
            const authorInitial = authorFirstName[0] || '';
            let authorString = `${authorLastName}, ${authorInitial}.`;
            
            // Add additional authors if any
            const additionalAuthors = document.querySelector('[name="additional_authors"]')?.value || '';
            if (additionalAuthors) {
                const authors = additionalAuthors.split('\n').filter(a => a.trim());
                authors.forEach(author => {
                    if (author.trim()) {
                        authorString += `, ${author.trim()}`;
                    }
                });
            }
            
            let titleString = title;
            if (subtitle) {
                titleString += `: ${subtitle}`;
            }
            
            let editionString = '';
            if (edition && edition !== '1') {
                if (edition === '2') editionString = ' (2nd ed.)';
                else if (edition === '3') editionString = ' (3rd ed.)';
                else editionString = ` (${edition}th ed.)`;
            }
            
            const citation = `${authorString} (${publicationYear}). <em>${titleString}</em>${editionString}. ${publisher}.`;
            document.getElementById('citation-preview').innerHTML = citation;
        }
    }

    // Update citation when form fields change
    document.addEventListener('DOMContentLoaded', function() {
        const formFields = ['author_last_name', 'author_first_name', 'publication_year', 
                        'title', 'subtitle', 'edition', 'publisher', 'additional_authors'];
        
        formFields.forEach(fieldName => {
            const field = document.querySelector(`[name="${fieldName}"]`);
            if (field) {
                field.addEventListener('input', updateCitationPreview);
                field.addEventListener('change', updateCitationPreview);
            }
        });
        
        // Initial update
        updateCitationPreview();
    });
</script>

<style>
/* Custom styling for form fields */
input, select, textarea {
    @apply w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors;
}

/* Hide default file input */
input[type="file"] {
    @apply absolute inset-0 w-full h-full opacity-0 cursor-pointer;
}

/* Style for checkboxes */
input[type="checkbox"] {
    @apply w-4 h-4 text-amber-600 border-gray-300 rounded focus:ring-amber-500;
}

/* Style for file upload labels */
input[type="file"] + label {
    @apply cursor-pointer;
}

/* Style for preview images */
.preview-image {
    @apply transition-all duration-200 hover:opacity-90;
}
</style>
{% endblock %}