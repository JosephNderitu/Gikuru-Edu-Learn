{% extends 'core/base_with_sidebar.html' %}
{% block content %}
<div class="min-h-screen bg-gray-50 py-4 px-3 xs:py-6 xs:px-4 sm:py-8">
    <div class="max-w-2xl mx-auto">
        
        <!-- Header -->
        <div class="text-center mb-6 xs:mb-8">
            <div class="w-12 h-12 xs:w-14 xs:h-14 sm:w-16 sm:h-16 mx-auto mb-3 xs:mb-4 bg-gradient-to-br from-green-500 to-emerald-600 rounded-full flex items-center justify-center shadow-lg">
                <i class="fas fa-graduation-cap text-white text-lg xs:text-xl"></i>
            </div>
            <h1 class="text-xl xs:text-2xl sm:text-3xl font-bold text-gray-800 mb-2">Grade Submission</h1>
            <p class="text-gray-600 text-sm xs:text-base">Evaluate and provide feedback for student work</p>
        </div>

        <!-- Enhanced Student & Assignment Info -->
        <div class="bg-white rounded-lg xs:rounded-xl shadow-sm border border-gray-200 p-4 xs:p-6 mb-4 xs:mb-6">
            <!-- Student Details Section -->
            <div class="mb-4 xs:mb-6 pb-4 xs:pb-6 border-b border-gray-200">
                <h3 class="text-xs xs:text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3 xs:mb-4 flex items-center space-x-2">
                    <i class="fas fa-user-graduate text-blue-500"></i>
                    <span>Student Details</span>
                </h3>
                <div class="flex flex-col xs:flex-row xs:items-center xs:space-x-4 space-y-3 xs:space-y-0">
                    <!-- Student Avatar & Basic Info -->
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 xs:w-14 xs:h-14 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center shadow-md flex-shrink-0">
                            <span class="text-white font-semibold text-base xs:text-lg">
                                {{ submission.student.get_full_name|make_list|first|upper }}
                            </span>
                        </div>
                        <div class="min-w-0 flex-1">
                            <p class="font-semibold text-gray-800 text-sm xs:text-base truncate">{{ submission.student.get_full_name }}</p>
                            <p class="text-gray-500 text-xs xs:text-sm truncate">{{ submission.student.email }}</p>
                            <div class="flex items-center space-x-2 mt-1">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    <i class="fas fa-user-graduate mr-1 text-xs"></i>
                                    Student
                                </span>
                                {% if submission.submitted_at %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <i class="fas fa-clock mr-1 text-xs"></i>
                                    Submitted
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submission Meta -->
                    <div class="flex-1 min-w-0">
                        <div class="grid grid-cols-2 gap-2 xs:gap-3 text-xs xs:text-sm">
                            <div class="flex items-center space-x-1 text-gray-600">
                                <i class="fas fa-calendar text-gray-400 text-xs"></i>
                                <span>Submitted:</span>
                            </div>
                            <div class="text-gray-800 font-medium">
                                {{ submission.submitted_at|date:"M d, Y"|default:"Not submitted" }}
                            </div>
                            
                            <div class="flex items-center space-x-1 text-gray-600">
                                <i class="fas fa-clock text-gray-400 text-xs"></i>
                                <span>Time:</span>
                            </div>
                            <div class="text-gray-800 font-medium">
                                {{ submission.submitted_at|date:"H:i"|default:"--:--" }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assignment Details -->
            <div class="mb-4 xs:mb-6">
                <h3 class="text-xs xs:text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3 xs:mb-4 flex items-center space-x-2">
                    <i class="fas fa-tasks text-purple-500"></i>
                    <span>Assignment Details</span>
                </h3>
                <div class="flex flex-col sm:flex-row sm:items-start sm:space-x-4 space-y-3 sm:space-y-0">
                    <div class="flex items-start space-x-3 flex-1">
                        <div class="w-10 h-10 xs:w-12 xs:h-12 bg-gradient-to-br from-purple-500 to-pink-600 rounded-lg flex items-center justify-center shadow-md flex-shrink-0">
                            <i class="fas fa-tasks text-white text-sm xs:text-base"></i>
                        </div>
                        <div class="min-w-0 flex-1">
                            <p class="font-semibold text-gray-800 text-sm xs:text-base mb-1">{{ submission.assignment.title }}</p>
                            <p class="text-gray-600 text-xs xs:text-sm mb-2 line-clamp-2">{{ submission.assignment.description|truncatewords:15 }}</p>
                            <div class="flex flex-wrap gap-2">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                    <i class="fas fa-book mr-1 text-xs"></i>
                                    {{ submission.assignment.subject.title }}
                                </span>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                                    <i class="fas fa-calendar-alt mr-1 text-xs"></i>
                                    Due: {{ submission.assignment.due_date|date:"M d" }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submission Content -->
            <div class="space-y-4 xs:space-y-6">
                <!-- Submitted Files -->
                {% if submission.file %}
                <div class="pt-4 border-t border-gray-200">
                    <h3 class="text-xs xs:text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3 flex items-center space-x-2">
                        <i class="fas fa-paperclip text-blue-500"></i>
                        <span>Submitted Files</span>
                    </h3>
                    <div class="flex flex-col xs:flex-row xs:items-center xs:space-x-3 space-y-2 xs:space-y-0">
                        <a href="{{ submission.file.url }}" target="_blank"
                           class="inline-flex items-center space-x-2 bg-blue-50 hover:bg-blue-100 text-blue-700 px-3 xs:px-4 py-2 xs:py-3 rounded-lg transition-colors border border-blue-200 text-sm xs:text-base w-full xs:w-auto justify-center">
                            <i class="fas fa-download"></i>
                            <span class="font-medium">Download Submission File</span>
                        </a>
                        <div class="text-xs xs:text-sm text-gray-500 flex items-center space-x-1 justify-center xs:justify-start">
                            <i class="fas fa-info-circle text-blue-500"></i>
                            <span>{{ submission.file.size|filesizeformat }}</span>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Written Answer -->
                {% if submission.answer %}
                <div class="pt-4 border-t border-gray-200">
                    <h3 class="text-xs xs:text-sm font-semibold text-gray-500 uppercase tracking-wide mb-2 flex items-center space-x-2">
                        <i class="fas fa-edit text-green-500"></i>
                        <span>Written Answer</span>
                        <span class="text-xs text-gray-400 font-normal normal-case">({{ submission.answer|wordcount }} words)</span>
                    </h3>
                    <div class="bg-gray-50 p-3 xs:p-4 rounded-lg border border-gray-200 max-h-40 xs:max-h-48 overflow-y-auto">
                        <p class="text-gray-700 text-xs xs:text-sm leading-relaxed whitespace-pre-wrap">{{ submission.answer|linebreaks }}</p>
                    </div>
                </div>
                {% endif %}

                <!-- Additional Comments -->
                {% if submission.comment %}
                <div class="pt-4 border-t border-gray-200">
                    <h3 class="text-xs xs:text-sm font-semibold text-gray-500 uppercase tracking-wide mb-2 flex items-center space-x-2">
                        <i class="fas fa-comment text-yellow-500"></i>
                        <span>Student Comments</span>
                    </h3>
                    <div class="bg-yellow-50 p-3 xs:p-4 rounded-lg border border-yellow-200">
                        <p class="text-yellow-800 text-xs xs:text-sm leading-relaxed italic">"{{ submission.comment }}"</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Grading Form -->
        <div class="bg-white rounded-lg xs:rounded-xl shadow-sm border border-gray-200">
            <div class="bg-gradient-to-r from-green-600 to-emerald-700 px-4 xs:px-6 py-3 xs:py-4 rounded-t-lg xs:rounded-t-xl">
                <h3 class="text-base xs:text-lg font-semibold text-white flex items-center space-x-2 justify-center xs:justify-start">
                    <i class="fas fa-edit"></i>
                    <span>Evaluation & Feedback</span>
                </h3>
            </div>

            <form method="POST" id="gradingForm" class="p-4 xs:p-6 space-y-4 xs:space-y-6">
                {% csrf_token %}

                <!-- Grade Field -->
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700 flex items-center space-x-2">
                        <i class="fas fa-star text-yellow-500 text-sm"></i>
                        <span>Grade</span>
                        <span class="text-xs text-gray-400 font-normal">(minimum 1)</span>
                    </label>
                    <div class="relative">
                        <input type="number" step="0.1" name="grade" min="1"
                               value="{{ submission.grade|default:'' }}"
                               class="w-full px-3 xs:px-4 py-2 xs:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200 bg-white placeholder-gray-400 text-sm xs:text-base"
                               placeholder="Enter grade (e.g., 8.5)"
                               required>
                        <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                            <i class="fas fa-percentage text-xs xs:text-sm"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500">Enter a grade of 1 or higher</p>
                </div>

                <!-- Feedback Field -->
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700 flex items-center space-x-2">
                        <i class="fas fa-comment-dots text-blue-500 text-sm"></i>
                        <span>Feedback</span>
                        <span class="text-xs text-gray-400 font-normal">(optional)</span>
                    </label>
                    <div class="relative">
                        <textarea name="feedback" rows="4 xs:rows-6"
                                  class="w-full px-3 xs:px-4 py-2 xs:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-white placeholder-gray-400 resize-none text-sm xs:text-base"
                                  placeholder="Provide constructive feedback for the student...">{{ submission.feedback|default:'' }}</textarea>
                        <div class="absolute right-3 top-3 text-gray-400">
                            <i class="fas fa-text-height text-xs xs:text-sm"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500">Helpful feedback improves student learning</p>
                </div>

                <!-- Validation Requirements -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 xs:p-4">
                    <div class="flex items-start space-x-2 xs:space-x-3">
                        <i class="fas fa-exclamation-triangle text-yellow-500 mt-0.5 text-sm"></i>
                        <div class="text-xs xs:text-sm text-yellow-800">
                            <p class="font-medium mb-1">Grading Requirements:</p>
                            <ul class="space-y-1">
                                <li class="flex items-start space-x-1">
                                    <span class="mt-0.5">•</span>
                                    <span>Grade must be 1 or higher</span>
                                </li>
                                <li class="flex items-start space-x-1">
                                    <span class="mt-0.5">•</span>
                                    <span>Grades can include decimals (e.g., 7.5, 8.0)</span>
                                </li>
                                <li class="flex items-start space-x-1">
                                    <span class="mt-0.5">•</span>
                                    <span>Provide constructive feedback to help students improve</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col xs:flex-row gap-3 xs:gap-4 pt-4 border-t border-gray-200">
                    <a href="{% url 'assignment_submissions' submission.assignment.id %}" 
                       class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 xs:py-3 px-4 xs:px-6 rounded-lg font-semibold transition flex items-center justify-center space-x-2 order-2 xs:order-1 text-sm xs:text-base">
                        <i class="fas fa-arrow-left"></i>
                        <span>Back to Submissions</span>
                    </a>
                    
                    <button type="submit" id="submitGradeBtn"
                            class="bg-gradient-to-r from-green-600 to-emerald-700 hover:from-green-700 hover:to-emerald-800 text-white py-2 xs:py-3 px-4 xs:px-6 rounded-lg font-semibold shadow-lg transition-all duration-200 transform hover:scale-105 flex items-center justify-center space-x-2 order-1 xs:order-2 text-sm xs:text-base">
                        <i class="fas fa-check-circle"></i>
                        <span>Submit Grade</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Grading Tips -->
        <div class="mt-4 xs:mt-6 bg-blue-50 rounded-lg p-3 xs:p-4 border border-blue-200">
            <div class="flex items-start space-x-2 xs:space-x-3">
                <i class="fas fa-lightbulb text-blue-500 mt-0.5 text-sm"></i>
                <div>
                    <h4 class="text-xs xs:text-sm font-semibold text-blue-800 mb-1">Grading Best Practices</h4>
                    <ul class="text-xs text-blue-700 space-y-1">
                        <li class="flex items-start space-x-1">
                            <span class="mt-0.5">•</span>
                            <span>Be specific and constructive in your feedback</span>
                        </li>
                        <li class="flex items-start space-x-1">
                            <span class="mt-0.5">•</span>
                            <span>Highlight both strengths and areas for improvement</span>
                        </li>
                        <li class="flex items-start space-x-1">
                            <span class="mt-0.5">•</span>
                            <span>Consider the assignment rubric and learning objectives</span>
                        </li>
                        <li class="flex items-start space-x-1">
                            <span class="mt-0.5">•</span>
                            <span>Provide examples or suggestions for future work</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Include SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('gradingForm');
    const gradeInput = document.querySelector('input[name="grade"]');

    // Form validation with SweetAlert
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const grade = parseFloat(gradeInput.value);
        
        // Validate grade is at least 1
        if (isNaN(grade) || grade < 1) {
            Swal.fire({
                title: 'Invalid Grade!',
                html: `
                    <div class="text-left">
                        <p class="text-gray-700 mb-3 text-sm xs:text-base">Please enter a valid grade that meets the requirements:</p>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-3">
                            <div class="flex items-center space-x-2 text-red-700">
                                <i class="fas fa-exclamation-circle"></i>
                                <div>
                                    <p class="font-medium text-sm">Grade must be 1 or higher</p>
                                    <p class="text-xs mt-1">Current value: ${gradeInput.value || 'Empty'}</p>
                                </div>
                            </div>
                        </div>
                        <ul class="text-xs xs:text-sm text-gray-600 space-y-1">
                            <li class="flex items-center space-x-2">
                                <i class="fas fa-check-circle text-green-500 text-xs"></i>
                                <span>Minimum grade: 1</span>
                            </li>
                            <li class="flex items-center space-x-2">
                                <i class="fas fa-check-circle text-green-500 text-xs"></i>
                                <span>Decimals allowed (e.g., 7.5)</span>
                            </li>
                            <li class="flex items-center space-x-2">
                                <i class="fas fa-check-circle text-green-500 text-xs"></i>
                                <span>Whole numbers preferred</span>
                            </li>
                        </ul>
                    </div>
                `,
                icon: 'error',
                confirmButtonText: 'Fix Grade',
                confirmButtonColor: '#ef4444',
                customClass: {
                    popup: 'rounded-xl xs:rounded-2xl',
                    confirmButton: 'px-4 xs:px-6 py-2 rounded-lg font-semibold text-sm xs:text-base'
                }
            }).then(() => {
                gradeInput.focus();
                gradeInput.select();
            });
            return;
        }

        // Show confirmation before submitting
        Swal.fire({
            title: 'Submit Grade?',
            html: `
                <div class="text-left">
                    <p class="text-gray-700 mb-2 text-sm xs:text-base">You are about to assign a grade of <strong>${grade}</strong> to:</p>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <p class="font-medium text-gray-800 text-sm xs:text-base">{{ submission.student.get_full_name }}</p>
                        <p class="text-xs xs:text-sm text-gray-600">{{ submission.assignment.title }}</p>
                    </div>
                    <p class="text-xs xs:text-sm text-red-500 mt-2">This action is very critical to students.</p>
                </div>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, Submit Grade',
            cancelButtonText: 'Review Again',
            confirmButtonColor: '#10b981',
            cancelButtonColor: '#6b7280',
            customClass: {
                popup: 'rounded-xl xs:rounded-2xl',
                confirmButton: 'px-4 xs:px-6 py-2 rounded-lg font-semibold text-sm xs:text-base',
                cancelButton: 'px-4 xs:px-6 py-2 rounded-lg font-semibold text-sm xs:text-base'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                form.submit();
            }
        });
    });

    // Real-time grade validation
    gradeInput.addEventListener('input', function() {
        const grade = parseFloat(this.value);
        if (!isNaN(grade) && grade < 1) {
            this.classList.add('border-red-500', 'bg-red-50');
        } else {
            this.classList.remove('border-red-500', 'bg-red-50');
        }
    });
});
</script>

<style>
/* Form field styling */
input[type="number"], textarea {
    transition: all 0.2s ease;
}

/* SweetAlert customization */
.swal2-popup {
    border-radius: 12px !important;
}

@media (min-width: 480px) {
    .swal2-popup {
        border-radius: 16px !important;
    }
}

.swal2-confirm, .swal2-cancel {
    border-radius: 8px !important;
    font-weight: 600 !important;
}

/* Custom scrollbar for written answer */
.bg-gray-50::-webkit-scrollbar {
    width: 4px;
}

.bg-gray-50::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 2px;
}

.bg-gray-50::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 2px;
}

.bg-gray-50::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}
</style>
{% endblock %}