{% extends "core/base_with_sidebar.html" %}
{% load static %}
{% block content %}
<div class="w-full bg-gradient-to-r from-blue-600 to-indigo-500 py-10 px-8 text-white">
    <div class="max-w-5xl mx-auto flex flex-col sm:flex-row sm:items-center gap-6">
        <div class="relative">
            <div class="w-28 h-28 rounded-full overflow-hidden border-4 border-white">
                {% if student.profile_picture %}
                    <img src="{{ student.profile_picture.url }}" alt="Profile" class="w-full h-full object-cover" />
                {% else %}
                    <img src="https://i.pravatar.cc/300" alt="Profile" class="w-full h-full object-cover" />
                {% endif %}
            </div>
            <button type="button" onclick="document.getElementById('profile_picture').click()" 
                    class="absolute bottom-0 right-0 bg-white text-blue-600 rounded-full p-1 shadow-lg hover:bg-gray-100 transition-colors edit-btn">
                <i class="fa-solid fa-camera text-sm"></i>
            </button>
        </div>
        <div>
            <h1 class="text-3xl font-bold">{{ student.get_display_name|default:student.username  }}</h1>
            <p class="text-lg opacity-90">
                {% if student.profession %}{{ student.profession }}{% else %}Complete your profile to add a title{% endif %}
            </p>
            <div class="flex flex-wrap gap-4 mt-3 text-sm opacity-90">
                <div class="flex items-center gap-1">
                    <i class="fa-solid fa-envelope"></i> {{ student.email }}
                </div>
                <div class="flex items-center gap-1">
                    <i class="fa-solid fa-user-clock"></i> Member since {{ student.date_joined|date:"M j, Y" }}
                </div>
            </div>
        </div>
    </div>
</div>

<form method="POST" enctype="multipart/form-data" id="profile-form">
    {% csrf_token %}
    
    <!-- Hidden file input for profile picture -->
    <input type="file" name="profile_picture" id="profile_picture" class="hidden" accept="image/*" onchange="this.form.submit()">
    
    <!-- Hidden fields for JSON data -->
    <input type="hidden" name="education_entries" id="education_entries" value="{{ student.education|default:'[]' }}">
    <input type="hidden" name="interests_entries" id="interests_entries" value="{{ student.interests|default:'[]' }}">

    <div class="max-w-5xl mx-auto px-8 -mt-6">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 text-center">
            <div class="bg-white p-6 rounded-xl shadow">
                <p class="text-3xl font-bold text-blue-600">{{ enrolled_subjects_count }}</p>
                <p class="text-sm mt-2 text-gray-600">Courses Enrolled</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow">
                <p class="text-3xl font-bold text-blue-600">{{ completed_courses_count }}</p>
                <p class="text-sm mt-2 text-gray-600">Courses Completed</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow">
                <p class="text-3xl font-bold text-blue-600">{{ learning_hours }}</p>
                <p class="text-sm mt-2 text-gray-600">Learning Hours</p>
            </div>
        </div>

        <!-- Contact Information Section -->
        <section class="bg-white mt-8 p-6 rounded-xl shadow">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold flex items-center gap-2 text-gray-800">
                    <i class="fa-solid fa-address-card text-blue-600"></i>
                    Contact Information
                </h2>
                <button type="button" onclick="enableEdit('contact')" class="text-blue-600 hover:text-blue-700 text-sm font-medium flex items-center gap-1">
                    <i class="fa-solid fa-pencil text-xs"></i>
                    Edit
                </button>
            </div>
            
            <!-- Display Mode -->
            <div id="contact-display" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Personal Details -->
                    <div class="space-y-3">
                        <div class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg">
                            <i class="fa-solid fa-user text-blue-600 w-4"></i>
                            <div class="min-w-0 flex-1">
                                <p class="text-sm text-gray-500 truncate">First Name</p>
                                <p class="font-medium text-gray-900 truncate">
                                    {% if student.first_name %}{{ student.first_name }}{% else %}<span class="text-gray-400">Not set</span>{% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg">
                            <i class="fa-solid fa-user text-blue-600 w-4"></i>
                            <div class="min-w-0 flex-1">
                                <p class="text-sm text-gray-500 truncate">Last Name</p>
                                <p class="font-medium text-gray-900 truncate">
                                    {% if student.last_name %}{{ student.last_name }}{% else %}<span class="text-gray-400">Not set</span>{% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg">
                            <i class="fa-solid fa-graduation-cap text-blue-600 w-4"></i>
                            <div class="min-w-0 flex-1">
                                <p class="text-sm text-gray-500 truncate">Current Status</p>
                                <p class="font-medium text-gray-900 truncate">
                                    {% if student.profession %}{{ student.profession }}{% else %}<span class="text-gray-400">Not set</span>{% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contact Details -->
                    <div class="space-y-3">
                        <div class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg">
                            <i class="fa-solid fa-phone text-blue-600 w-4"></i>
                            <div class="min-w-0 flex-1">
                                <p class="text-sm text-gray-500 truncate">Phone Number</p>
                                <p class="font-medium text-gray-900 truncate">
                                    {% if student.phone_number %}{{ student.phone_number }}{% else %}<span class="text-gray-400">Not set</span>{% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg">
                            <i class="fa-solid fa-envelope text-blue-600 w-4"></i>
                            <div class="min-w-0 flex-1">
                                <p class="text-sm text-gray-500 truncate">Email</p>
                                <p class="font-medium text-gray-900 truncate">{{ student.email }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Edit Mode -->
            <div id="contact-edit" class="hidden space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Personal Information -->
                    <div class="space-y-3">
                        <div>
                            <label for="id_first_name" class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                            {{ form.first_name }}
                        </div>
                        <div>
                            <label for="id_last_name" class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                            {{ form.last_name }}
                        </div>
                        <div>
                            <label for="id_profession" class="block text-sm font-medium text-gray-700 mb-1">Current Status</label>
                            {{ form.profession }}
                            <p class="text-xs text-gray-500 mt-1">e.g., High School Student, College Student, Working Professional</p>
                        </div>
                    </div>
                    
                    <!-- Contact Details -->
                    <div class="space-y-3">
                        <div>
                            <label for="id_phone_number" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                            {{ form.phone_number }}
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                            <p class="text-sm text-gray-900">{{ student.email }}</p>
                            <p class="text-xs text-gray-500 mt-1">Email cannot be changed</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-2 pt-3 border-t border-gray-200">
                    <button type="button" onclick="saveEdit('contact')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium flex items-center gap-1">
                        <i class="fa-solid fa-check text-xs"></i>
                        Save
                    </button>
                    <button type="button" onclick="cancelEdit('contact')" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors text-sm font-medium flex items-center gap-1">
                        <i class="fa-solid fa-times text-xs"></i>
                        Cancel
                    </button>
                </div>
            </div>
        </section>

        <!-- About Me Section -->
        <section class="bg-white mt-10 p-6 rounded-xl shadow">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i class="fa-solid fa-user text-blue-600"></i> About Me
                </h2>
                <button type="button" onclick="enableEdit('bio')" class="edit-btn text-blue-600 hover:text-blue-700">
                    <i class="fa-solid fa-pencil"></i> Edit
                </button>
            </div>
            
            <div id="bio-display" class="text-gray-700 leading-relaxed">
                {% if student.bio %}
                    {{ student.bio|linebreaks }}
                {% else %}
                    <p class="text-gray-500 italic">Tell us about yourself, your learning goals, and interests...</p>
                {% endif %}
            </div>
            
            <div id="bio-edit" class="hidden">
                {{ form.bio }}
                <div class="flex gap-2 mt-3">
                    <button type="button" onclick="saveEdit('bio')" class="save-btn bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                        Save
                    </button>
                    <button type="button" onclick="cancelEdit('bio')" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                        Cancel
                    </button>
                </div>
            </div>
        </section>

        <!-- Learning Interests Section -->
        <section class="bg-white mt-10 p-6 rounded-xl shadow">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i class="fa-solid fa-heart text-blue-600"></i> Learning Interests
                </h2>
                <button type="button" onclick="enableEdit('interests')" class="edit-btn text-blue-600 hover:text-blue-700">
                    <i class="fa-solid fa-pencil"></i> Edit
                </button>
            </div>
            
            <div id="interests-display" class="flex flex-wrap gap-3">
                {% if student.interests %}
                    {% for interest in student.interests %}
                        <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">{{ interest }}</span>
                    {% endfor %}
                {% else %}
                    <p class="text-gray-500 italic">Add your learning interests and topics you want to explore...</p>
                {% endif %}
            </div>
            
            <div id="interests-edit" class="hidden">
                <div class="flex flex-wrap gap-2 mb-3" id="interests-tags"></div>
                <div class="flex gap-2">
                    <input type="text" id="new-interest" placeholder="Add a learning interest" 
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="button" onclick="addInterest()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        Add
                    </button>
                </div>
                <div class="flex gap-2 mt-3">
                    <button type="button" onclick="saveEdit('interests')" class="save-btn bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                        Save
                    </button>
                    <button type="button" onclick="cancelEdit('interests')" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                        Cancel
                    </button>
                </div>
            </div>
        </section>

        <!-- Education Background Section -->
        <section class="bg-white mt-10 p-6 rounded-xl shadow mb-10">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i class="fa-solid fa-graduation-cap text-blue-600"></i> Education Background
                </h2>
                <button type="button" onclick="enableEdit('education')" class="edit-btn text-blue-600 hover:text-blue-700">
                    <i class="fa-solid fa-pencil"></i> Edit
                </button>
            </div>
            
            <div id="education-display" class="space-y-6">
                {% if student.education %}
                    {% for edu in student.education %}
                        <div class="border-l-4 border-blue-600 pl-4">
                            <h3 class="font-semibold text-lg">{{ edu.degree }}</h3>
                            <p class="text-sm text-gray-600">{{ edu.school }} • {{ edu.year }}</p>
                            {% if edu.description %}
                                <p class="text-gray-700 text-sm mt-1">{{ edu.description }}</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-gray-500 italic">Add your education background...</p>
                {% endif %}
            </div>
            
            <div id="education-edit" class="hidden">
                <div id="education-entries" class="space-y-4 mb-4"></div>
                <button type="button" onclick="addEducationEntry()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 mb-3">
                    <i class="fa-solid fa-plus"></i> Add Education
                </button>
                <div class="flex gap-2">
                    <button type="button" onclick="saveEdit('education')" class="save-btn bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                        Save
                    </button>
                    <button type="button" onclick="cancelEdit('education')" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                        Cancel
                    </button>
                </div>
            </div>
        </section>

        <!-- Save Button (hidden by default) -->
        <div class="fixed bottom-6 right-6 hidden" id="global-save">
            <button type="submit" class="bg-green-600 text-white px-6 py-3 rounded-full shadow-lg hover:bg-green-700 transition-colors">
                <i class="fa-solid fa-floppy-disk mr-2"></i>Save All Changes
            </button>
        </div>
    </div>
</form>

<script>
  let currentEdit = null;

  function enableEdit(section) {
      console.log('enableEdit called for:', section);
      
      // Hide all edit sections first
      document.querySelectorAll('[id$="-edit"]').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('[id$="-display"]').forEach(el => el.classList.remove('hidden'));
      
      // Show current edit section
      document.getElementById(`${section}-display`).classList.add('hidden');
      document.getElementById(`${section}-edit`).classList.remove('hidden');
      
      currentEdit = section;
      
      // Initialize edit content
      if (section === 'bio') {
          document.getElementById('id_bio').value = `{{ student.bio|default:''|escapejs }}`;
      } else if (section === 'interests') {
          initInterestsEdit();
      } else if (section === 'education') {
          initEducationEdit();
      }
      
      showGlobalSave();
  }

  function saveEdit(section) {
      console.log('saveEdit called for:', section);
      
      // PRESERVE existing data for other sections before saving
      preserveOtherSectionsData(section);
      
      // Save data to hidden fields first
      if (section === 'interests') {
          if (!saveInterests()) {
              alert('Error saving interests. Please check the data.');
              return false;
          }
      } else if (section === 'education') {
          if (!saveEducation()) {
              // Don't submit if education save failed
              return false;
          }
      }
      
      // Show what's being saved
      const interestsValue = document.getElementById('interests_entries').value;
      const educationValue = document.getElementById('education_entries').value;
      console.log('Interests to save:', interestsValue);
      console.log('Education to save:', educationValue);
      
      // Validate JSON before submitting
      try {
          if (interestsValue && interestsValue !== '[]') {
              JSON.parse(interestsValue);
          }
          if (educationValue && educationValue !== '[]') {
              JSON.parse(educationValue);
          }
      } catch (e) {
          console.error('Invalid JSON detected:', e);
          console.log('Problematic educationValue:', educationValue);
          alert('Error: Invalid data format. Please try again. Details: ' + e.message);
          return false;
      }
      
      // SUBMIT THE FORM
      console.log('Submitting form...');
      document.getElementById('profile-form').submit();
      return true;
  }

  function preserveOtherSectionsData(currentSection) {
      // For sections that aren't being edited, preserve their current data from the display
      if (currentSection !== 'interests') {
          preserveInterestsData();
      }
      if (currentSection !== 'education') {
          preserveEducationData();
      }
  }

  function preserveInterestsData() {
      try {
          const interestsContainer = document.getElementById('interests-display');
          const interests = [];
          
          // Extract interests from the display elements
          interestsContainer.querySelectorAll('span').forEach(span => {
              const interest = span.textContent.trim();
              if (interest && interest !== 'Add your learning interests and topics you want to explore...') {
                  interests.push(interest);
              }
          });
          
          const interestsJson = JSON.stringify(interests);
          document.getElementById('interests_entries').value = interestsJson;
          console.log('Preserved interests data:', interestsJson);
      } catch (error) {
          console.error('Error preserving interests data:', error);
      }
  }

  function preserveEducationData() {
      try {
          const educationContainer = document.getElementById('education-display');
          const education = [];
          
          // Extract education from display elements
          if (!educationContainer.querySelector('.text-gray-500')) { // If not empty message
              educationContainer.querySelectorAll('.border-l-4').forEach(eduElement => {
                  const degree = eduElement.querySelector('h3').textContent.trim();
                  const schoolYear = eduElement.querySelector('p').textContent.trim();
                  const [school, year] = schoolYear.split('•').map(s => s.trim());
                  const descriptionElement = eduElement.querySelector('.text-gray-700');
                  const description = descriptionElement ? descriptionElement.textContent.trim() : '';
                  
                  if (degree && school && year) {
                      education.push({
                          degree: degree,
                          school: school,
                          year: year,
                          description: description
                      });
                  }
              });
          }
          
          const educationJson = JSON.stringify(education);
          document.getElementById('education_entries').value = educationJson;
          console.log('Preserved education data:', educationJson);
      } catch (error) {
          console.error('Error preserving education data:', error);
      }
  }

  function cancelEdit(section) {
      console.log('cancelEdit called for:', section);
      document.getElementById(`${section}-display`).classList.remove('hidden');
      document.getElementById(`${section}-edit`).classList.add('hidden');
      
      currentEdit = null;
      checkGlobalSave();
  }

  function showGlobalSave() {
      document.getElementById('global-save').classList.add('hidden'); // Hide global save for individual edits
  }

  function checkGlobalSave() {
      const hasActiveEdit = document.querySelectorAll('[id$="-edit"]:not(.hidden)').length > 0;
      if (!hasActiveEdit) {
          document.getElementById('global-save').classList.add('hidden');
      }
  }

  // Interests Management
  function initInterestsEdit() {
      try {
          // Get interests from display instead of template variable to avoid JSON issues
          const interestsContainer = document.getElementById('interests-display');
          const interests = [];
          
          // Extract interests from the display elements
          interestsContainer.querySelectorAll('span').forEach(span => {
              const interest = span.textContent.trim();
              if (interest && interest !== 'Add your learning interests and topics you want to explore...') {
                  interests.push(interest);
              }
          });
          
          const container = document.getElementById('interests-tags');
          container.innerHTML = '';
          
          console.log('Initializing interests:', interests);
          
          interests.forEach(interest => {
              addInterestTag(interest, container);
          });
      } catch (error) {
          console.error('Error initializing interests:', error);
          document.getElementById('interests-tags').innerHTML = '';
      }
  }

  function addInterest() {
      const input = document.getElementById('new-interest');
      const interest = input.value.trim();
      if (interest) {
          addInterestTag(interest, document.getElementById('interests-tags'));
          input.value = '';
          input.focus();
      }
  }

  function addInterestTag(interest, container) {
      const tag = document.createElement('div');
      tag.className = 'flex items-center gap-1 bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm';
      tag.innerHTML = `
          <span class="interest-text">${interest.replace(/"/g, '&quot;')}</span>
          <button type="button" onclick="this.parentElement.remove()" class="text-blue-700 hover:text-blue-900 ml-1">
              <i class="fa-solid fa-times text-xs"></i>
          </button>
      `;
      container.appendChild(tag);
  }

  function saveInterests() {
      try {
          const tags = Array.from(document.getElementById('interests-tags').children);
          const interests = tags.map(tag => {
              return tag.querySelector('.interest-text').textContent.trim();
          }).filter(interest => interest); // Remove empty interests
          
          console.log('Saving interests:', interests);
          
          const interestsJson = JSON.stringify(interests);
          console.log('Interests JSON:', interestsJson);
          document.getElementById('interests_entries').value = interestsJson;
          return true;
      } catch (error) {
          console.error('Error saving interests:', error);
          return false;
      }
  }

  // Education Management
  function initEducationEdit() {
      try {
          // Get education from display instead of template variable to avoid JSON issues
          const educationContainer = document.getElementById('education-display');
          const education = [];
          
          // Extract education from display elements
          if (!educationContainer.querySelector('.text-gray-500')) { // If not empty message
              educationContainer.querySelectorAll('.border-l-4').forEach(eduElement => {
                  const degree = eduElement.querySelector('h3').textContent.trim();
                  const schoolYear = eduElement.querySelector('p').textContent.trim();
                  const [school, year] = schoolYear.split('•').map(s => s.trim());
                  const descriptionElement = eduElement.querySelector('.text-gray-700');
                  const description = descriptionElement ? descriptionElement.textContent.trim() : '';
                  
                  if (degree && school && year) {
                      education.push({
                          degree: degree,
                          school: school,
                          year: year,
                          description: description
                      });
                  }
              });
          }
          
          const container = document.getElementById('education-entries');
          container.innerHTML = '';
          
          console.log('Initializing education:', education);
          
          if (education.length === 0) {
              addEducationEntry();
          } else {
              education.forEach(edu => {
                  addEducationEntry(edu);
              });
          }
      } catch (error) {
          console.error('Error initializing education:', error);
          document.getElementById('education-entries').innerHTML = '';
          addEducationEntry();
      }
  }

  function addEducationEntry(edu = {}) {
      const container = document.getElementById('education-entries');
      const entry = document.createElement('div');
      entry.className = 'border border-gray-300 rounded-lg p-4 mb-4';
      
      // Escape values to prevent JSON issues
      const degree = (edu.degree || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      const school = (edu.school || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      const year = (edu.year || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      const description = (edu.description || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      
      entry.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
              <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Degree/Level *</label>
                  <input type="text" class="edu-degree w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                        value="${degree}" placeholder="e.g., High School Diploma, Bachelor's Degree" required>
              </div>
              <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Year *</label>
                  <input type="text" class="edu-year w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                        value="${year}" placeholder="e.g., 2023" required>
              </div>
          </div>
          <div class="mb-3">
              <label class="block text-sm font-medium text-gray-700 mb-1">School/Institution *</label>
              <input type="text" class="edu-school w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                    value="${school}" placeholder="e.g., University of California" required>
          </div>
          <div class="mb-3">
              <label class="block text-sm font-medium text-gray-700 mb-1">Description (Optional)</label>
              <textarea class="edu-description w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                        rows="2" placeholder="e.g., Major in Computer Science, Minor in Mathematics">${description}</textarea>
          </div>
          <div class="flex justify-between items-center">
              <button type="button" class="remove-education-btn text-red-600 hover:text-red-700 text-sm flex items-center">
                  <i class="fa-solid fa-trash mr-1"></i> Remove Entry
              </button>
              <span class="text-xs text-gray-500">* Required fields</span>
          </div>
      `;
      
      // Add event listener for the remove button
      const removeBtn = entry.querySelector('.remove-education-btn');
      removeBtn.addEventListener('click', function() {
          entry.remove();
      });
      
      container.appendChild(entry);
  }

  function saveEducation() {
      try {
          const entries = Array.from(document.getElementById('education-entries').children);
          const education = entries.map(entry => {
              const degree = entry.querySelector('.edu-degree').value.trim();
              const school = entry.querySelector('.edu-school').value.trim();
              const year = entry.querySelector('.edu-year').value.trim();
              const description = entry.querySelector('.edu-description').value.trim();
              
              console.log('Processing entry:', { degree, school, year, description });
              
              return {
                  degree: degree,
                  school: school,
                  year: year,
                  description: description
              };
          }).filter(edu => {
              // Only save complete entries
              const isComplete = edu.degree && edu.school && edu.year;
              console.log('Entry complete?', isComplete, edu);
              return isComplete;
          });
          
          console.log('Saving education entries:', education);
          
          const educationJson = JSON.stringify(education);
          console.log('Education JSON to save:', educationJson);
          
          // Validate the JSON before setting it
          JSON.parse(educationJson);
          
          document.getElementById('education_entries').value = educationJson;
          return true;
      } catch (error) {
          console.error('Error saving education:', error);
          alert('Error: ' + error.message);
          return false;
      }
  }

  // Handle Enter key in interests input
  document.addEventListener('DOMContentLoaded', function() {
      const interestsInput = document.getElementById('new-interest');
      if (interestsInput) {
          interestsInput.addEventListener('keypress', function(e) {
              if (e.key === 'Enter') {
                  e.preventDefault();
                  addInterest();
              }
          });
      }
      
      // Initialize hidden fields with current data from display
      preserveInterestsData();
      preserveEducationData();
      
      console.log('Profile editing functions loaded successfully');
      console.log('Initial interests_entries:', document.getElementById('interests_entries').value);
      console.log('Initial education_entries:', document.getElementById('education_entries').value);
  });
</script>

{% endblock %}